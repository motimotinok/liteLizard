# LiteLizard 仕様ドラフト v2

最終更新: 2026-02-17

## 1. 方針
- 文書本体は Markdown (`.md`) として保存する。
- 解析結果は別ファイルの JSON として保存する。
- 解析はアプリから自社サーバー API にのみ送信する。
- 解析機能はログイン必須。ユーザー個別の API キー入力は廃止する。

## 2. ファイル構成
- 本文: `*.md`
- 解析: `*.litelizard.analysis.json`
- 1文書につき1つの解析ファイルを対応させる。

例:
- `essay.md`
- `essay.litelizard.analysis.json`

## 3. Markdown 構造ルール
- 段落は「1つの段落ブロック = 1つの paragraph エントリ」として扱う。
- ユーザーの追記時は段落単位でエントリを追加する。
- 各段落には永続的な `paragraphId` を付与する。
- `paragraphId` は高エントロピー乱数で生成し、一意であることを保証する。
- DnD や本文編集では `paragraphId` は不変。

補足:
- `paragraphId` の埋め込み方法は実装時に統一する。
- 推奨は HTML コメント等の不可視メタデータで保持し、通常表示を汚さないこと。

## 4. 解析データモデル
- 解析 JSON は paragraph 単位で以下を持つ。
  - `paragraphId`
  - `order`
  - `meaningRelative`（文書全体に対する相対的意味）
  - `readerReactionPrediction`（読者感想の予想）
  - `status`（`fresh | stale | pending | failed`）

推奨追加項目:
- `sourceHash`（本文同期確認）
- `updatedAt`
- `analysisVersion`

## 5. 保存と編集確定
- 編集中はインメモリ状態として保持する。
- 本文 (`.md`) と解析 (`.json`) の更新確定はユーザーの明示保存時のみ行う。
- DnD で順序変更した場合も、確定は保存時のみ。
- 保存せずにエディタを閉じた場合、ディスク上ファイルは変更しない。

## 6. 解析実行仕様
- 全体解析:
  - 解析ペイン上部ボタンから実行。
  - 対象文書全体の構造・流れを基準に評価。
- 局所解析:
  - 各段落カード右下ボタンから実行。
  - 対象段落中心で再解析し、必要最小限の周辺文脈のみ参照。

## 7. 解析方針（コスト/安定性）
- ユーザー自由入力プロンプトは提供しない。
- 代わりに制約付きの方針設定を提供する。
  - 記事タイプ（例: エッセイ / 解説 / 日記）
  - 想定読者（例: 一般 / 初学者 / 専門）
  - 評価強度（例: 軽め / 標準 / 厳しめ）
- これらをサーバー側の固定テンプレートにマッピングして解析する。

## 8. 認証・API
- ログイン必須（未ログイン時は解析 UI を無効化）。
- クライアントは自社サーバー API のみ呼び出す。
- サーバー側で LLM プロバイダキーを管理する。
- クライアント側にユーザー API キー設定画面は持たない。

## 9. エラーポリシー
- 段落単位失敗は `failed` を保持し、成功段落は反映可能とする。
- ただし全体解析時は「成功件数/失敗件数」を明示表示する。
- ネットワーク・認証失敗時は再試行導線を表示する。

## 10. 実装メモ（移行）
- v1 の `.litelizard.json` から v2 への移行ツールを別途用意する。
- 初期は v2 新規作成のみ対応し、既存読込は段階導入でも可。
